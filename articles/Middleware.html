<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Middleware • RestRserve</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Middleware">
<meta property="og:description" content="RestRserve">
<meta property="og:image" content="http://restrserve.org/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">RestRserve</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/RestRserve.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Authentication.html">Authentication</a>
    </li>
    <li>
      <a href="../articles/ContentHandlers.html">Body encoding and decoding</a>
    </li>
    <li>
      <a href="../articles/Logging.html">Logging</a>
    </li>
    <li>
      <a href="../articles/Middleware.html">Middleware</a>
    </li>
    <li>
      <a href="../articles/benchmarks/Benchmarks.html">Benchmarks</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/rexyai/RestRserve/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Middleware</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/rexyai/RestRserve/blob/master/vignettes/Middleware.Rmd"><code>vignettes/Middleware.Rmd</code></a></small>
      <div class="hidden name"><code>Middleware.Rmd</code></div>

    </div>

    
    
<div id="middleware" class="section level2">
<h2 class="hasAnchor">
<a href="#middleware" class="anchor"></a>Middleware</h2>
<p>Many web API frameworks contain a concept called “middleware” (but every language/framework calls it differently - filters, middleware, etc). Essentially, the middleware performs some specific function on the HTTP request or response before or after the handler. Common tasks to offload to a middleware would be logging, authorization, body compression, etc.</p>
<p><code>RestRserve</code> comes with several build-in middlewares (<code>AuthMiddleware</code>, <code>CORSMiddleware</code>) and generic <code>Middleware</code> class which facilitates user to create a custom middleware.</p>
<p>Let’s see it in action in example below.</p>
</div>
<div id="logging" class="section level2">
<h2 class="hasAnchor">
<a href="#logging" class="anchor"></a>Logging</h2>
<p>Let’s say you have a simple app which has only a single endpoint - it simply convert query string parameters into a JSON format and sends it back:</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">RestRserve</span>)

<span class="no">app</span> <span class="kw">=</span> <span class="no">Application</span>$<span class="fu">new</span>(<span class="kw">content_type</span> <span class="kw">=</span> <span class="st">"application/json"</span>)

<span class="no">backend</span> <span class="kw">=</span> <span class="no">BackendRserve</span>$<span class="fu">new</span>()

<span class="no">app</span>$<span class="fu">add_get</span>(<span class="st">"/foo"</span>, <span class="kw">function</span>(<span class="no">request</span>, <span class="no">response</span>) {
  <span class="no">body</span> <span class="kw">=</span> <span class="kw pkg">RestRserve</span><span class="kw ns">::</span><span class="fu"><a href="../reference/to_json.html">to_json</a></span>(<span class="no">request</span>$<span class="no">parameters_query</span>)
  <span class="no">response</span>$<span class="fu">set_body</span>(<span class="no">body</span>)
  <span class="co"># specify that there is no need to specially encode the body as</span>
  <span class="co"># we've already set it to a JSON</span>
  <span class="no">response</span>$<span class="no">encode</span> <span class="kw">=</span> <span class="no">identity</span>
})</pre></body></html></div>
<p>See it in action:</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="no">req</span> <span class="kw">=</span> <span class="no">Request</span>$<span class="fu">new</span>(<span class="kw">path</span> <span class="kw">=</span> <span class="st">"/foo"</span>, <span class="kw">method</span> <span class="kw">=</span> <span class="st">"GET"</span>, <span class="kw">parameters_query</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">key1</span> <span class="kw">=</span> <span class="st">"value1"</span>, <span class="kw">key2</span> <span class="kw">=</span> <span class="st">"value2"</span>))
<span class="no">resp</span> <span class="kw">=</span> <span class="no">app</span>$<span class="fu">process_request</span>(<span class="no">req</span>)
<span class="no">resp</span>$<span class="no">body</span>
<span class="co">#&gt; [1] "{\"key1\":\"value1\",\"key2\":\"value2\"}"</span></pre></body></html></div>
<p>Assume you would like to analyze how your web service works. For that you may need log every request and response in order to see whether service replies with errors and what can cause these errors. This is a perfect task for a middleware and here is how you can achieve this with <code>RestRserve</code>:</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="no">logging_middleware</span> <span class="kw">=</span> <span class="no">Middleware</span>$<span class="fu">new</span>(
  <span class="kw">process_request</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">request</span>, <span class="no">response</span>) {
    <span class="no">msg</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
      <span class="kw">middleware</span> <span class="kw">=</span> <span class="st">"logging_middleware"</span>,
      <span class="kw">request_id</span> <span class="kw">=</span> <span class="no">request</span>$<span class="no">id</span>,
      <span class="kw">request</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">headers</span> <span class="kw">=</span> <span class="no">request</span>$<span class="no">headers</span>, <span class="kw">method</span> <span class="kw">=</span> <span class="no">request</span>$<span class="no">method</span>, <span class="kw">path</span> <span class="kw">=</span> <span class="no">request</span>$<span class="no">path</span>),
      <span class="kw">timestamp</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span>()
    )
    <span class="no">msg</span> <span class="kw">=</span> <span class="kw pkg">RestRserve</span><span class="kw ns">::</span><span class="fu"><a href="../reference/to_json.html">to_json</a></span>(<span class="no">msg</span>)
    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="no">msg</span>, <span class="kw">sep</span> <span class="kw">=</span> <span class="st">'\n'</span>)
  },
  <span class="kw">process_response</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">request</span>, <span class="no">response</span>) {
    <span class="no">msg</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
      <span class="kw">middleware</span> <span class="kw">=</span> <span class="st">"logging_middleware"</span>,
      <span class="co"># we would like to have a request_id for each response in order to correlate</span>
      <span class="co"># request and response</span>
      <span class="kw">request_id</span> <span class="kw">=</span> <span class="no">request</span>$<span class="no">id</span>,
      <span class="kw">response</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">headers</span> <span class="kw">=</span> <span class="no">response</span>$<span class="no">headers</span>, <span class="kw">status_code</span> <span class="kw">=</span> <span class="no">response</span>$<span class="no">status_code</span>, <span class="kw">body</span> <span class="kw">=</span> <span class="no">response</span>$<span class="no">body</span>),
      <span class="kw">timestamp</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span>()
    )
    <span class="no">msg</span> <span class="kw">=</span> <span class="fu"><a href="../reference/to_json.html">to_json</a></span>(<span class="no">msg</span>)
    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="no">msg</span>, <span class="kw">sep</span> <span class="kw">=</span> <span class="st">'\n'</span>)
  },
  <span class="kw">id</span> <span class="kw">=</span> <span class="st">"logging"</span>
)

<span class="no">app</span>$<span class="fu">append_middleware</span>(<span class="no">logging_middleware</span>)</pre></body></html></div>
<p>Let’s test again:</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">req</span> <span class="kw">=</span> <span class="no">Request</span>$<span class="fu">new</span>(<span class="kw">path</span> <span class="kw">=</span> <span class="st">"/foo"</span>, <span class="kw">method</span> <span class="kw">=</span> <span class="st">"GET"</span>, <span class="kw">parameters_query</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">key1</span> <span class="kw">=</span> <span class="st">"value1"</span>, <span class="kw">key2</span> <span class="kw">=</span> <span class="st">"value2"</span>))
<span class="no">resp</span> <span class="kw">=</span> <span class="no">app</span>$<span class="fu">process_request</span>(<span class="no">req</span>)
<span class="co">#&gt; {"middleware":"logging_middleware","request_id":"4f4e82ea-70cf-11ea-9d47-42010a140055","request":{"headers":{},"method":"GET","path":"/foo"},"timestamp":"2020-03-28 08:37:07"}</span>
<span class="co">#&gt; {"middleware":"logging_middleware","request_id":"4f4e82ea-70cf-11ea-9d47-42010a140055","response":{"headers":{"Server":"RestRserve/0.2.1"},"status_code":200,"body":"{\"key1\":\"value1\",\"key2\":\"value2\"}"},"timestamp":"2020-03-28 08:37:07"}</span></pre></body></html></div>
<p>Let’s see what will happen if we will send request to nonexistent endpoint:</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="no">req</span> <span class="kw">=</span> <span class="no">Request</span>$<span class="fu">new</span>(<span class="kw">path</span> <span class="kw">=</span> <span class="st">"/foo2"</span>, <span class="kw">method</span> <span class="kw">=</span> <span class="st">"GET"</span>, <span class="kw">parameters_query</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">key1</span> <span class="kw">=</span> <span class="st">"value1"</span>, <span class="kw">key2</span> <span class="kw">=</span> <span class="st">"value2"</span>))
<span class="no">resp</span> <span class="kw">=</span> <span class="no">app</span>$<span class="fu">process_request</span>(<span class="no">req</span>)
<span class="co">#&gt; {"middleware":"logging_middleware","request_id":"4f58299e-70cf-11ea-9d47-42010a140055","request":{"headers":{},"method":"GET","path":"/foo2"},"timestamp":"2020-03-28 08:37:08"}</span>
<span class="co">#&gt; {"middleware":"logging_middleware","request_id":"4f58299e-70cf-11ea-9d47-42010a140055","response":{"headers":{"Server":"RestRserve/0.2.1"},"status_code":404,"body":"404 Not Found"},"timestamp":"2020-03-28 08:37:08"}</span></pre></body></html></div>
<p>Later you will see all the responses with errors in the log (<code>status_code</code> &gt;= 400). Also you will be able to find corresponding requests by inspecting <code>request_id</code> field.</p>
</div>
<div id="middleware-order" class="section level2">
<h2 class="hasAnchor">
<a href="#middleware-order" class="anchor"></a>Middleware order</h2>
<p>It is important to understand that middlewares are executed in order you’ve added them (that’s why it is called <code>append_middleware</code>). Flow is shown on the diagram below.</p>
<p><img src="img/middleware-order.png" width="320"></p>
</div>
<div id="compression" class="section level2">
<h2 class="hasAnchor">
<a href="#compression" class="anchor"></a>Compression</h2>
<p>To demonstrate the order in which middleware called let’s consider another example.</p>
<p>Sometimes it it useful to compress response body in order to send less data over the wire. Here we will implement a middleware which will compress response with <code>gzip</code>.</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="no">gzip_middleware</span> <span class="kw">=</span> <span class="no">Middleware</span>$<span class="fu">new</span>(
  <span class="kw">process_request</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">request</span>, <span class="no">response</span>) {
    <span class="no">msg</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
      <span class="kw">middleware</span> <span class="kw">=</span> <span class="st">"gzip_middleware"</span>,
      <span class="kw">request_id</span> <span class="kw">=</span> <span class="no">request</span>$<span class="no">id</span>,
      <span class="kw">timestamp</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span>()
    )
    <span class="no">msg</span> <span class="kw">=</span> <span class="fu"><a href="../reference/to_json.html">to_json</a></span>(<span class="no">msg</span>)
    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="no">msg</span>, <span class="kw">sep</span> <span class="kw">=</span> <span class="st">'\n'</span>)
  },
  <span class="kw">process_response</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">request</span>, <span class="no">response</span>) {

    <span class="co"># compress body</span>
    <span class="no">response</span>$<span class="fu">set_header</span>(<span class="st">"Content-encoding"</span>, <span class="st">"gzip"</span>)
    <span class="no">response</span>$<span class="fu">set_body</span>(<span class="fu"><a href="https://rdrr.io/r/base/memCompress.html">memCompress</a></span>(<span class="no">response</span>$<span class="no">body</span>, <span class="st">"gzip"</span>))

    <span class="no">msg</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
      <span class="kw">middleware</span> <span class="kw">=</span> <span class="st">"gzip_middleware"</span>,
      <span class="kw">request_id</span> <span class="kw">=</span> <span class="no">request</span>$<span class="no">id</span>,
      <span class="kw">timestamp</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span>()
    )
    <span class="no">msg</span> <span class="kw">=</span> <span class="fu"><a href="../reference/to_json.html">to_json</a></span>(<span class="no">msg</span>)
    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="no">msg</span>, <span class="kw">sep</span> <span class="kw">=</span> <span class="st">'\n'</span>)
  },
  <span class="kw">id</span> <span class="kw">=</span> <span class="st">"gzip"</span>
)
<span class="no">app</span>$<span class="fu">append_middleware</span>(<span class="no">gzip_middleware</span>)</pre></body></html></div>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="no">req</span> <span class="kw">=</span> <span class="no">Request</span>$<span class="fu">new</span>(<span class="kw">path</span> <span class="kw">=</span> <span class="st">"/foo"</span>, <span class="kw">method</span> <span class="kw">=</span> <span class="st">"GET"</span>, <span class="kw">parameters_query</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">key1</span> <span class="kw">=</span> <span class="st">"value1"</span>, <span class="kw">key2</span> <span class="kw">=</span> <span class="st">"value2"</span>))
<span class="no">resp</span> <span class="kw">=</span> <span class="no">app</span>$<span class="fu">process_request</span>(<span class="no">req</span>)
<span class="co">#&gt; {"middleware":"logging_middleware","request_id":"4f5b3eea-70cf-11ea-9d47-42010a140055","request":{"headers":{},"method":"GET","path":"/foo"},"timestamp":"2020-03-28 08:37:08"}</span>
<span class="co">#&gt; {"middleware":"gzip_middleware","request_id":"4f5b3eea-70cf-11ea-9d47-42010a140055","timestamp":"2020-03-28 08:37:08"}</span>
<span class="co">#&gt; {"middleware":"gzip_middleware","request_id":"4f5b3eea-70cf-11ea-9d47-42010a140055","timestamp":"2020-03-28 08:37:08"}</span>
<span class="co">#&gt; {"middleware":"logging_middleware","request_id":"4f5b3eea-70cf-11ea-9d47-42010a140055","response":{"headers":{"Server":"RestRserve/0.2.1","Content-encoding":"gzip"},"status_code":200,"body":"eJyrVspOrTRUslIqS8wpTTVU0gHxjWB8I6VaAK3KCjs="},"timestamp":"2020-03-28 08:37:08"}</span></pre></body></html></div>
<p>And now check what is actual decoded response body:</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/rawConversion.html">rawToChar</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/memCompress.html">memDecompress</a></span>(<span class="no">resp</span>$<span class="no">body</span>, <span class="st">"gzip"</span>))
<span class="co">#&gt; [1] "{\"key1\":\"value1\",\"key2\":\"value2\"}"</span></pre></body></html></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Dmitriy Selivanov, Artem Klevtsov, <a href="https://rexy.ai"></a><a href="https://www.rexy.ai"><img src="https://s3-eu-west-1.amazonaws.com/rexy.ai/images/rexy-logo.svg" height="32" alt="rexy.ai"></a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.0.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
